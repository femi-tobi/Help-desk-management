<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Report a problem</title>
  <!-- AI Chat Widget Styles -->
  <style>
    #aiChatWidget {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 340px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.18);
      z-index: 9999;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #aiChatHeader {
      background: #22a7f0;
      color: #fff;
      padding: 10px 16px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    #aiChatBody {
      padding: 12px;
      height: 220px;
      overflow-y: auto;
      background: #f8fafd;
      font-size: 15px;
    }
    #aiChatInputArea {
      display: flex;
      border-top: 1px solid #e0e0e0;
      background: #fff;
    }
    #aiChatInput {
      flex: 1;
      border: none;
      padding: 10px;
      font-size: 15px;
      outline: none;
      background: #f4f4f4;
    }
    #aiChatSendBtn {
      background: #22a7f0;
      color: #fff;
      border: none;
      padding: 0 18px;
      font-size: 15px;
      cursor: pointer;
      border-radius: 0 0 10px 0;
    }
    #aiChatCloseBtn {
      background: none;
      border: none;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
    }
    #aiChatWidget.minimized #aiChatBody, #aiChatWidget.minimized #aiChatInputArea {
      display: none;
    }
    #aiChatWidget.minimized {
      width: 180px;
      height: auto;
    }
  </style>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Arial,Helvetica,sans-serif;background:#ffffff;color:#111}

    /* navbar */
    .navbar{display:flex;justify-content:space-between;align-items:center;background:#fafafa;padding:12px 22px;border-bottom:1px solid #ececec}
    .navbar-left{display:flex;align-items:center;gap:14px}
    .navbar-left img{height:48px}
    .site-name{font-weight:700}
    .navbar-right{display:flex;align-items:center;gap:12px}
    .nav-cta{background:#22a7f0;color:#fff;padding:8px 14px;border-radius:24px;border:none}
    .user-icon{width:42px;height:42px;border-radius:50%;background:#eef6fb;display:flex;align-items:center;justify-content:center}

    /* page container */
    .wrap{max-width:1200px;margin:28px auto;padding:0 20px}

    /* search bar centered */
    .search-wrap{display:flex;justify-content:center;margin-bottom:38px}
    .search{width:100%;max-width:680px;border-radius:14px;border:1px solid #cbd5e1;padding:12px 14px;background:#fbf8f8;display:flex;align-items:center;gap:10px}
    .search input{flex:1;border:0;background:transparent;font-size:15px;outline:none}
    .search button{border:0;background:transparent;cursor:pointer}

    /* main grid: CTA (left) and image (right) */
    .hero-grid{display:grid;grid-template-columns:1fr 380px;gap:34px;align-items:start}

    .cta{background:#072544;color:#fff;padding:36px;border-radius:36px;box-shadow:0 10px 30px rgba(7,37,68,0.06);min-height:160px;display:flex;flex-direction:column;justify-content:center;opacity:0;transform:translateY(12px);animation:reveal 640ms ease forwards}
    .cta h2{font-size:20px;line-height:1.25;margin-bottom:26px}
    .cta .btn{display:inline-block;background:#22a7f0;color:#fff;width: 23%;padding:5px 20px;border-radius:10px;text-decoration:none}

    .figure{display:flex;flex-direction:column;align-items:center;gap:18px}
    .actions{display:flex;gap:12px}
    .pill{background:#22a7f0;color:#fff;padding:10px 14px;border-radius:18px;border:0}

    @keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-10px)}100%{transform:translateY(0)}}
    @keyframes reveal{to{opacity:1;transform:none}}

    /* precise spacing */
    .cta{border-radius:34px;padding-left:42px;padding-right:42px;margin-top: 85px;margin-left: 0;}
    .cta h2{font-size:22px}

    /* responsive */
    @media (max-width:980px){.hero-grid{grid-template-columns:1fr 300px}.figure img{width:240px}}
    @media (max-width:720px){
      .hero-grid{grid-template-columns:1fr;}
      .figure{order:2}
      .cta{order:1;padding:26px}
      .figure img{width:200px}
      .search{max-width:520px}
    }

    /* small visual polish */
    .search{border-radius:18px}
    .search input::placeholder{color:#7b8794}
    .pill:first-child{background:#1ea1f0}
  </style>
</head>
<body>
  <!-- Notification Modal -->
  <div id="notifModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:2000;justify-content:center;align-items:center;">
    <div style="background:#fff;padding:24px 28px 18px 28px;border-radius:12px;min-width:320px;max-width:90vw;max-height:80vh;overflow-y:auto;position:relative;">
      <button id="closeNotifModal" style="position:absolute;top:10px;right:16px;font-size:20px;background:none;border:none;cursor:pointer;">&times;</button>
      <h3 style="margin-bottom:18px;color:#22a7f0;">Assigned Reports</h3>
      <ul id="notifList" style="list-style:none;padding:0;margin:0;"></ul>
    </div>
  </div>

  <nav class="navbar">
    <div class="navbar-left">
      <img src="mb.jpeg" alt="logo">
      <div class="site-name"><h3>WELCOME,</h3>
        <h5>oluwatobi</h5>
      </div>
    </div>
    <div class="navbar-right">
  <button class="nav-cta"><a style="text-decoration: none; color: #ffffff;" href="reports.html">Reports</a></button>
  <button class="nav-cta" id="adminDashBtn" style="display:none;">Admin Dashboard</button>
      <button class="nav-cta" id="notifBtn" style="background:none;padding:0;border:none;box-shadow:none;cursor:pointer;position:relative;">
        <svg id="notifBell" width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle;">
          <path d="M12 22c1.1 0 2-.9 2-2h-4a2 2 0 002 2zm6-6V11c0-3.07-1.63-5.64-4.5-6.32V4a1.5 1.5 0 00-3 0v.68C7.63 5.36 6 7.92 6 11v5l-1.7 1.7A1 1 0 005 20h14a1 1 0 00.7-1.7L18 16z" stroke="#22a7f0" stroke-width="2" fill="none"/>
        </svg>
        <span id="notifBadge" style="display:none;position:absolute;top:2px;right:2px;width:10px;height:10px;background:#22a7f0;border-radius:50%;"></span>
      </button>
      <div class="user-icon" id="userIcon" style="position:relative;cursor:pointer;">U
        <div id="userDropdown" style="display:none;position:absolute;top:48px;right:0;min-width:120px;background:#fff;border-radius:12px;box-shadow:0 4px 18px rgba(34,167,240,0.13);padding:8px 0;z-index:20;">
          <button style="width:100%;background:none;color:#072544;text-align:left;padding:10px 18px;border:none;box-shadow:none;cursor:pointer;">Logout</button>
        </div>
      </div>
    </div>
  </nav>

  <div class="wrap">
    <div class="search-wrap">
      <div class="search" role="search" aria-label="Search reports">
        <input id="searchInput" type="search" placeholder="Search by reporter name or email" aria-label="Search reports" />
        <button aria-label="search" type="button" onclick="loadReports()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21l-4.35-4.35" stroke="#445" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="6" stroke="#445" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
    </div>

    <section class="hero-grid">
      <div class="cta">
        <h2>Do you have a problem you want us to work on?</h2>
        <a class="btn" href="modal.html">Log A Report</a>
      </div>

      <div class="figure">
        <img src="question.png" alt="Question illustration">
        <div class="actions">
          <div style="position:relative;">
            <button class="pill" id="filterBtn"><span id="filterLabel">Filter Name</span> ▾</button>
            <div id="filterDropdown" style="display:none;position:absolute;top:44px;left:0;min-width:180px;background:#fff;border-radius:12px;box-shadow:0 4px 18px rgba(34,167,240,0.13);padding:8px 0;z-index:10;">
              <button class="pill" style="width:100%;background:none;color:#072544;text-align:left;padding:10px 18px;box-shadow:none;" data-filter="Unanswered">Unanswered</button>
              <button class="pill" style="width:100%;background:none;color:#072544;text-align:left;padding:10px 18px;box-shadow:none;" data-filter="Assigned to me">Assigned to me</button>
              <button class="pill" style="width:100%;background:none;color:#072544;text-align:left;padding:10px 18px;box-shadow:none;" data-filter="All reports">All reports</button>
              <button class="pill" style="width:100%;background:none;color:#072544;text-align:left;padding:10px 18px;box-shadow:none;" data-filter="Assigned to others">Assigned to others</button>
            </div>
          </div>
          <a class="pill" href="all-reports.html" style="text-decoration:none;">See More</a>
        </div>
      </div>
    </section>

    <!-- Table now sits BELOW the grid, full width -->
    <div style="margin-top:38px;overflow-x:auto;">
      <table style="width:100%;border-collapse:collapse;background:#fff;border-radius:16px;box-shadow:0 2px 16px rgba(34,167,240,0.07);">
        <thead style="background:#f3f8fc;">
          <tr>
            <th style="padding:12px 10px;font-weight:600;color:#22a7f0;">S/N</th>
            <th style="padding:12px 10px;font-weight:600;color:#22a7f0;">Issue no</th>
            <th style="padding:12px 10px;font-weight:600;color:#22a7f0;">Issue reported</th>
            <th style="padding:12px 10px;font-weight:600;color:#22a7f0;">Issue description</th>
            <th style="padding:12px 10px;font-weight:600;color:#22a7f0;">Reported by</th>
            <th style="padding:12px 10px;font-weight:600;color:#22a7f0;">Resolution path</th>
            <th style="padding:12px 10px;font-weight:600;color:#22a7f0;">Department</th>
            <th style="padding:12px 10px;font-weight:600;color:#22a7f0;">Staff assigned</th>
            <th style="padding:12px 10px;font-weight:600;color:#22a7f0;">Status</th>
          </tr>
        </thead>
        <tbody id="reportTableBody">
          <!-- Report rows will appear here -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Show Admin Dashboard button if user is admin
    (function() {
      let currentUser = null;
      try { currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}'); } catch(e) {}
      if (currentUser && currentUser.role === 'admin') {
        var btn = document.getElementById('adminDashBtn');
        if (btn) btn.style.display = '';
        if (btn) btn.onclick = function() { window.location.href = 'admin.html'; };
      }
    })();
    // Show notification modal with assigned reports
    document.getElementById('notifBtn').addEventListener('click', function(e) {
      e.stopPropagation();
      const reports = JSON.parse(localStorage.getItem('helpdeskReports') || '[]');
      const userEmail = sessionStorage.getItem('userEmail');
      const notifList = document.getElementById('notifList');
      notifList.innerHTML = '';
      let found = false;
      reports.forEach(function(report, idx) {
        if (report.staff && userEmail && report.staff.toLowerCase() === userEmail.toLowerCase()) {
          found = true;
          const li = document.createElement('li');
          li.style.padding = '10px 0';
          li.style.borderBottom = '1px solid #e0e0e0';
          li.style.cursor = 'pointer';
          li.innerHTML = `<strong>From:</strong> ${report.reportedBy || ''} <br><strong>Issue:</strong> ${report.issue || ''}`;
          li.onclick = function() {
            sessionStorage.setItem('selectedReportIdx', idx);
            window.location.href = 'modal2.html';
          };
          notifList.appendChild(li);
        }
      });
      if (!found) {
        notifList.innerHTML = '<li style="color:#888;">No assigned reports.</li>';
      }
      document.getElementById('notifModal').style.display = 'flex';
    });

    // Close notification modal
    document.getElementById('closeNotifModal').addEventListener('click', function() {
      document.getElementById('notifModal').style.display = 'none';
    });

    // Optional: Close modal when clicking outside the content
    document.getElementById('notifModal').addEventListener('click', function(e) {
      if (e.target === this) this.style.display = 'none';
    });
    // Notification logic: show badge if logged-in user has a task assigned
    function updateNotification() {
      const reports = JSON.parse(localStorage.getItem('helpdeskReports') || '[]');
      const userEmail = sessionStorage.getItem('userEmail');
      let hasTask = false;
      for (const report of reports) {
        if (report.staff && userEmail && report.staff.toLowerCase() === userEmail.toLowerCase()) {
          hasTask = true;
          break;
        }
      }
      var notifBadge = document.getElementById('notifBadge');
      if (notifBadge) notifBadge.style.display = hasTask ? 'block' : 'none';
    }
    window.addEventListener('DOMContentLoaded', updateNotification);
    // Also update notification when reports are loaded
    window.addEventListener('DOMContentLoaded', function() {
      if (typeof loadReports === 'function') updateNotification();
    });
    // Load reports from localStorage and display in table
    function loadReports() {
      const reports = JSON.parse(localStorage.getItem('helpdeskReports') || '[]');
      const tbody = document.getElementById('reportTableBody');
      tbody.innerHTML = '';
      // Determine filter
      const filter = document.getElementById('filterLabel').textContent.trim();
      const userEmail = sessionStorage.getItem('userEmail') || '';
      let filtered = reports;
      if (filter === 'Unanswered') {
        filtered = reports.filter(r => !r.status || r.status === 'open');
      } else if (filter === 'Assigned to me') {
        filtered = reports.filter(r => r.staff && userEmail && r.staff.toLowerCase() === userEmail.toLowerCase());
      } else if (filter === 'Assigned to others') {
        filtered = reports.filter(r => r.staff && userEmail && r.staff.toLowerCase() !== userEmail.toLowerCase());
      } // else 'All reports' shows all

      // Search filter
      const searchValue = (document.getElementById('searchInput')?.value || '').trim().toLowerCase();
      if (searchValue) {
        filtered = filtered.filter(r => (r.reportedBy || '').toLowerCase().includes(searchValue));
      }

      filtered.forEach(function(report, idx) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>ISSUE-${1000 + idx}</td>
          <td>${report.issue || ''}</td>
          <td>${report.description || ''}</td>
          <td>${report.reportedBy || ''}</td>
          <td>${report.resolution || ''}</td>
          <td>${report.department || ''}</td>
          <td>${report.staff || ''}</td>
          <td>${report.status || ''}</td>
        `;
        tbody.appendChild(tr);
      });
  // Live search as user types
  document.getElementById('searchInput').addEventListener('input', loadReports);
    }
    window.addEventListener('DOMContentLoaded', loadReports);
    // populate navbar user display from sessionStorage
    (function(){
      try {
        var email = sessionStorage.getItem('userEmail');
        if (email) {
          var h5 = document.querySelector('.site-name h5');
          if (h5) h5.textContent = email;
          var avatar = document.querySelector('.user-icon');
          if (avatar && avatar.textContent.trim() === 'U') avatar.textContent = email.charAt(0).toUpperCase();
        }
      } catch (e) { /* ignore */ }
    })();
  

  // Dropdown logic for filter button
    const filterBtn = document.getElementById('filterBtn');
    const filterDropdown = document.getElementById('filterDropdown');
    const filterLabel = document.getElementById('filterLabel');
    filterBtn.onclick = function(e) {
      e.stopPropagation();
      filterDropdown.style.display = filterDropdown.style.display === 'block' ? 'none' : 'block';
    };
    document.addEventListener('click', function(e) {
      if (!filterDropdown.contains(e.target) && e.target !== filterBtn) {
        filterDropdown.style.display = 'none';
      }
    });
    filterDropdown.querySelectorAll('button').forEach(btn => {
      btn.onclick = function() {
        filterDropdown.style.display = 'none';
        filterLabel.textContent = btn.getAttribute('data-filter');
        loadReports();
      };
    });

    // Notification bell logic
    let hasNotification = false;
    function updateNotifIcon() {
      const bell = document.getElementById('notifBell');
      const badge = document.getElementById('notifBadge');
      if (hasNotification) {
        bell.innerHTML = '<path d="M12 22c1.1 0 2-.9 2-2h-4a2 2 0 002 2zm6-6V11c0-3.07-1.63-5.64-4.5-6.32V4a1.5 1.5 0 00-3 0v.68C7.63 5.36 6 7.92 6 11v5l-1.7 1.7A1 1 0 005 20h14a1 1 0 00.7-1.7L18 16z" fill="#22a7f0"/>';
        badge.style.display = 'block';
      } else {
        bell.innerHTML = '<path d="M12 22c1.1 0 2-.9 2-2h-4a2 2 0 002 2zm6-6V11c0-3.07-1.63-5.64-4.5-6.32V4a1.5 1.5 0 00-3 0v.68C7.63 5.36 6 7.92 6 11v5l-1.7 1.7A1 1 0 005 20h14a1 1 0 00.7-1.7L18 16z" stroke="#22a7f0" stroke-width="2" fill="none"/>';
        badge.style.display = 'none';
      }
    }
    document.getElementById('notifBtn').onclick = function() {
      hasNotification = !hasNotification;
      updateNotifIcon();
    };
    updateNotifIcon();

    // User icon dropdown logic
    const userIcon = document.getElementById('userIcon');
    const userDropdown = document.getElementById('userDropdown');
    userIcon.onclick = function(e) {
      e.stopPropagation();
      userDropdown.style.display = userDropdown.style.display === 'block' ? 'none' : 'block';
    };
    document.addEventListener('click', function(e) {
      if (!userDropdown.contains(e.target) && e.target !== userIcon) {
        userDropdown.style.display = 'none';
      }
    });
    // Logout button logic
    userDropdown.querySelector('button').onclick = function() {
      userDropdown.style.display = 'none';
      sessionStorage.clear();
      window.location.href = 'login.html';
    };
</script>

</body>
  <!-- AI Chat Widget -->
  <div id="aiChatWidget" class="minimized">
    <div id="aiChatHeader">
      <span>May & Baker AI</span>
      <button id="aiChatCloseBtn" title="Close">×</button>
    </div>
    <div id="aiChatBody" style="display:none;"></div>
    <div id="aiChatInputArea" style="display:none;">
      <input type="text" id="aiChatInput" placeholder="Ask me anything..." autocomplete="off" />
      <button id="aiChatSendBtn">Send</button>
    </div>
  </div>

  <script>
    // AI Chat Widget Logic (Hugging Face Inference API)
    (function() {
      const widget = document.getElementById('aiChatWidget');
      const header = document.getElementById('aiChatHeader');
      const closeBtn = document.getElementById('aiChatCloseBtn');
      const body = document.getElementById('aiChatBody');
      const inputArea = document.getElementById('aiChatInputArea');
      const input = document.getElementById('aiChatInput');
      const sendBtn = document.getElementById('aiChatSendBtn');
      let minimized = true;

      function toggleWidget() {
        minimized = !minimized;
        if (minimized) {
          widget.classList.add('minimized');
          body.style.display = 'none';
          inputArea.style.display = 'none';
        } else {
          widget.classList.remove('minimized');
          body.style.display = 'block';
          inputArea.style.display = 'flex';
          input.focus();
        }
      }
      header.onclick = function(e) {
        if (e.target === closeBtn) return;
        toggleWidget();
      };
      closeBtn.onclick = function(e) {
        widget.style.display = 'none';
        e.stopPropagation();
      };
      // Show on load (minimized)
      widget.classList.add('minimized');
      body.style.display = 'none';
      inputArea.style.display = 'none';

      // Chat logic
      function appendMessage(sender, text) {
        const msg = document.createElement('div');
        msg.style.marginBottom = '8px';
        msg.innerHTML = `<b style="color:${sender==='AI'?'#22a7f0':'#333'};">${sender}:</b> <span>${text.replace(/\n/g,'<br>')}</span>`;
        body.appendChild(msg);
        body.scrollTop = body.scrollHeight;
      }
      async function sendToAI(message) {
        appendMessage('You', message);
        appendMessage('AI', '<i>Thinking...</i>');
        body.scrollTop = body.scrollHeight;
        // Hugging Face Inference API (replace with your own key and model)
        const HF_API_TOKEN = 'YOUR_HF_API_KEY'; // <-- Replace with your Hugging Face API key
        const HF_MODEL = 'microsoft/DialoGPT-medium'; // Free conversational model
        try {
          const res = await fetch(`https://api-inference.huggingface.co/models/${HF_MODEL}`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${HF_API_TOKEN}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ inputs: message })
          });
          const data = await res.json();
          // Remove "Thinking..." message
          const aiMsgs = body.querySelectorAll('b');
          for (let i = aiMsgs.length - 1; i >= 0; i--) {
            if (aiMsgs[i].textContent === 'AI:') {
              aiMsgs[i].parentElement.remove();
              break;
            }
          }
          if (data && data.generated_text) {
            appendMessage('AI', data.generated_text);
          } else if (data && Array.isArray(data) && data[0] && data[0].generated_text) {
            appendMessage('AI', data[0].generated_text);
          } else if (data && data.error) {
            appendMessage('AI', `<span style='color:red;'>${data.error}</span>`);
          } else {
            appendMessage('AI', '<span style="color:red;">No response from AI.</span>');
          }
        } catch (e) {
          appendMessage('AI', `<span style='color:red;'>Error: ${e.message}</span>`);
        }
      }
      function handleSend() {
        const msg = input.value.trim();
        if (!msg) return;
        input.value = '';
        sendToAI(msg);
      }
      sendBtn.onclick = handleSend;
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') handleSend();
      });
    })();
  </script>
</html>
